---
import Layout from "../../../layouts/post.astro";
import { getAllPosts, getPost } from "../../../lib/hashnode/client";
import addLangPaths from "../../../lib/utils/add-lang-paths";

export async function getStaticPaths() {
  try {
    const data = await getAllPosts();
    const allPosts = data.publication.posts.edges;
    
    if (!allPosts || allPosts.length === 0) {
      console.warn("No posts found from Hashnode");
      return [];
    }
    
    return addLangPaths(
      allPosts.map((post: { node?: { slug?: string } }) => {
        if (!post.node?.slug) {
          console.warn("Post missing slug:", post);
          return null;
        }
        return {
          params: { slug: post.node.slug },
        };
      }).filter((item): item is { params: { slug: string } } => item !== null)
    );
  } catch (error) {
    console.error("Error in getStaticPaths for posts:", error);
    return [];
  }
}

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect("/404");
}

let post: Awaited<ReturnType<typeof getPost>>;
try {
  post = await getPost(slug);
} catch (error) {
  console.error(`Error fetching post with slug "${slug}":`, error);
  return Astro.redirect("/404");
}
---

<Layout post={post}>
  <Fragment set:html={post.content.html} />
</Layout>
